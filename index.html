<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªç„¶æ‹¼è¯» Pro - V25 è‡ªé€‰è¯­éŸ³ä¿®å¤ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    <style>
        :root {
            --primary: #7b61ff;
            --success: #52c41a;
            --success-bg: #d9f7be;
            --danger: #ff4d4f;
            --bg: #f5f7fa; 
            --font-main: "Segoe UI", "Microsoft YaHei", sans-serif;
            --font-mono: "Consolas", "Monaco", monospace; 
        }

        body { 
            font-family: var(--font-main); 
            background-color: var(--bg); 
            margin: 0; height: 100vh; 
            display: flex; flex-direction: column; overflow: hidden; 
            transition: background-color 0.5s ease;
        }

        .view-section { display: none; height: 100%; width: 100%; flex-direction: column; }
        .view-section.active { display: flex; }
        .dashboard-container { padding: 40px; max-width: 1000px; margin: 0 auto; width: 100%; overflow-y: auto; }
        
        .key-hint { display: inline-block; padding: 2px 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 12px; color: #999; margin-left: 5px; background: #fff; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 30px 0; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .stat-num { font-size: 36px; font-weight: 800; color: var(--primary); }
        
        .menu-btn { font-size: 18px; padding: 15px 40px; border-radius: 50px; border: none; cursor: pointer; font-weight: bold; margin: 0 10px; transition: transform 0.2s; position: relative; }
        .menu-btn:hover { transform: translateY(-3px); }
        .btn-primary { background: var(--primary); color: white; }
        
        .header { background: white; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; height: 60px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .step-indicators { display: flex; gap: 40px; }
        .step-ind { font-size: 20px; color: #ddd; font-weight: bold; transition: 0.3s; }
        .step-ind.active { color: var(--primary); transform: scale(1.1); }
        
        .stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; gap: 40px; }
        .instruction { font-size: 28px; color: #888; font-weight: 500; margin-top: 20px; }

        /* å£°éŸ³è®¾ç½®é¢æ¿ */
        .sound-settings { background: white; padding: 20px; border-radius: 15px; margin-bottom: 30px; display: flex; justify-content: center; gap: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .sound-col { display: flex; flex-direction: column; gap: 8px; align-items: flex-start; }
        .sound-label { font-size: 14px; font-weight: bold; color: #555; }
        .sound-select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; width: 260px; font-family: var(--font-main); font-size: 14px; }

        /* è¾“å…¥æ¡† */
        .rich-input-wrapper { 
            position: relative; display: inline-block; margin: 0 10px; 
            background: white; 
            border-radius: 20px; border: 5px solid #ccc;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08); cursor: text;
            transition: all 0.2s;
        }
        .visual-layer { 
            font-family: var(--font-mono); font-size: 80px; font-weight: 800; 
            text-align: center; width: 100%; height: 100%; line-height: 160px; 
            position: absolute; top: 0; left: 0; z-index: 1;
            pointer-events: none; white-space: pre;
            background: transparent !important; 
        }
        .ghost-input { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; 
            opacity: 0 !important; cursor: text; padding: 0; margin: 0; border: none;
        }
        .cursor {
            display: inline-block; width: 4px; height: 80px; background-color: #333;
            vertical-align: middle; margin-bottom: 12px; animation: blink 1s step-end infinite;
        }
        .ghost-input:not(:focus) + .visual-layer .cursor { display: none; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .rich-input-wrapper:focus-within { border-color: var(--primary); box-shadow: 0 0 0 6px rgba(123,97,255,0.2); }
        
        /* ç»¿è‰²åé¦ˆ */
        .rich-input-wrapper.correct { 
            border-color: var(--success) !important; 
            background-color: var(--success-bg) !important; 
            box-shadow: 0 0 30px rgba(82, 196, 26, 0.5) !important;
            transform: scale(1.05); 
        }
        .rich-input-wrapper.correct .c { color: #0050b3; } 
        .rich-input-wrapper.correct .v { color: #cf1322; }
        .rich-input-wrapper.error { border-color: var(--danger); animation: shake 0.4s; }
        .v { color: #ff4d4f; font-weight: 900; } 
        .c { color: #1890ff; } 
        @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-10px);} 75%{transform:translateX(10px);} }
        
        .enter-tip { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); color: #aaa; font-size: 14px; opacity: 0; transition: 0.3s; }
        .enter-tip.show { opacity: 1; }
        .summary-card { background: white; padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .drop-zone { border: 3px dashed #ccc; padding: 40px; background: white; margin: 20px auto; max-width: 600px; cursor: pointer; text-align: center; }
        
        .data-management { margin-top: 50px; padding-top: 30px; border-top: 2px dashed #e0e0e0; text-align: center; color: #666; }
        .data-btn { background: white; border: 1px solid #ccc; padding: 10px 20px; border-radius: 20px; cursor: pointer; margin: 5px 10px; font-weight: 600; color: #555; transition: all 0.2s; }
        .data-btn:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); }
        .btn-reset { border-color: #ffccc7; color: var(--danger); }
        .btn-reset:hover { background: var(--danger); color: white; border-color: var(--danger); }
    </style>
</head>
<body>

    <div id="view-dashboard" class="view-section active">
        <div class="dashboard-container">
            <h1 style="text-align:center; color:#333;">ğŸ“š è‡ªç„¶æ‹¼è¯» Pro</h1>
            <p style="text-align:center; color:#666;">ä»Šæ—¥å¾…å­¦ï¼š<b id="daily-target" style="color:var(--primary)">0</b> è¯</p>
            
            <!-- ğŸ”Š å£°éŸ³è®¾ç½® (ä¿®å¤ç‰ˆ) -->
            <div class="sound-settings">
                <div class="sound-col">
                    <span class="sound-label">ğŸ—£ï¸ è¯»å•è¯çš„å£°éŸ³</span>
                    <select id="cfg-word-voice" class="sound-select" onchange="App.saveVoiceConfig()">
                        <option value="ONLINE_US">ğŸ‡ºğŸ‡¸ åœ¨çº¿çœŸäººç¾éŸ³ (æ¨è)</option>
                        <option value="ONLINE_UK">ğŸ‡¬ğŸ‡§ åœ¨çº¿çœŸäººè‹±éŸ³</option>
                        <!-- ç³»ç»Ÿè¯­éŸ³ä¼šé€šè¿‡ JS è¿½åŠ åœ¨è¿™é‡Œ -->
                    </select>
                </div>
                <div class="sound-col">
                    <span class="sound-label">ğŸ”” æç¤ºéŸ³/æŠ¥é”™éŸ³</span>
                    <select id="cfg-prompt-voice" class="sound-select" onchange="App.saveVoiceConfig()">
                        <option value="ONLINE_US">ğŸ‡ºğŸ‡¸ åœ¨çº¿çœŸäººç¾éŸ³</option>
                        <option value="ONLINE_UK">ğŸ‡¬ğŸ‡§ åœ¨çº¿çœŸäººè‹±éŸ³ (æ¨è)</option>
                        <!-- ç³»ç»Ÿè¯­éŸ³ä¼šé€šè¿‡ JS è¿½åŠ åœ¨è¿™é‡Œ -->
                    </select>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card"><span class="stat-num" id="stat-total">0</span><br>æ€»è¯åº“</div>
                <div class="stat-card"><span class="stat-num" id="stat-learned" style="color:var(--success)">0</span><br>å·²æŒæ¡</div>
                <div class="stat-card"><span class="stat-num" id="stat-remain" style="color:#faad14">0</span><br>æœªå­¦ä¹ </div>
                <div class="stat-card"><span class="stat-num" id="stat-mistakes" style="color:var(--danger)">0</span><br>é”™é¢˜æœ¬</div>
            </div>
            
            <div style="text-align:center; margin-bottom:20px;">
                <label>è®¡åˆ’ï¼š<input type="number" id="plan-days" value="21" style="width:50px;text-align:center" onchange="App.saveConfig()"> å¤©</label>
                &nbsp;&nbsp;
                <select id="learn-order"><option value="random">ğŸ² éšæœºä¹±åº</option><option value="sequence">ğŸ”¢ åˆ—è¡¨é¡ºåº</option></select>
            </div>
            
            <div style="text-align:center;">
                <button class="menu-btn btn-primary" onclick="App.start('daily')">ğŸš€ å¼€å§‹ç»ƒä¹  <span class="key-hint">Enter</span></button>
                <button class="menu-btn" style="color:var(--danger); border:2px solid var(--danger); background:white;" onclick="App.start('review')">ğŸ’Š å¤ä¹ é”™é¢˜</button>
                <button class="menu-btn" style="border:2px solid #ddd; background:white;" onclick="App.switchView('import')">ğŸ“‚ å¯¼å…¥æ–°è¯</button>
            </div>

            <div class="data-management">
                <button class="data-btn" onclick="DataManager.exportData()">â¬‡ï¸ å¤‡ä»½</button>
                <button class="data-btn" onclick="document.getElementById('backup-input').click()">â¬†ï¸ æ¢å¤</button>
                <button class="data-btn" style="border-color:var(--primary); color:var(--primary)" onclick="DataManager.exportMistakesTxt()">ğŸ“„ å¯¼å‡ºé”™é¢˜æœ¬</button>
                <button class="data-btn btn-reset" onclick="DataManager.resetData()">ğŸ—‘ï¸ é‡ç½®</button>
                <input type="file" id="backup-input" hidden accept=".json" onchange="DataManager.importData(this.files[0])">
            </div>
        </div>
    </div>

    <div id="view-import" class="view-section">
        <div class="dashboard-container">
            <h2 style="text-align:center">å¯¼å…¥æ–°å•è¯</h2>
            <div class="drop-zone" onclick="document.getElementById('file-input').click()">
                <div style="font-size:30px">ğŸ“„</div>
                <div>ç‚¹å‡»ä¸Šä¼  Word / Txt</div>
                <div id="file-name" style="color:var(--primary); margin-top:10px; font-weight:bold;"></div>
            </div>
            <input type="file" id="file-input" hidden accept=".docx,.txt" onchange="Importer.handleFile(this.files[0])">
            <textarea id="manual-text" placeholder="æ ¼å¼1: apple è‹¹æœ&#10;æ ¼å¼2: hand/some è‹±ä¿Šçš„" style="width:100%; height:150px; margin:20px 0; padding:10px; font-family: monospace; border:2px solid #eee; border-radius:10px;"></textarea>
            <div style="text-align:center;">
                <button class="menu-btn btn-primary" onclick="Importer.parseManual()">ç¡®å®šå¯¼å…¥</button>
                <button class="menu-btn" onclick="App.switchView('dashboard')">è¿”å›ä¸»é¡µ</button>
            </div>
        </div>
    </div>

    <div id="view-practice" class="view-section">
        <div class="header">
            <button onclick="App.endSession()" style="padding:5px 15px; cursor:pointer;">Esc é€€å‡º</button>
            <div class="step-indicators">
                <div id="ind-1" class="step-ind">1. è¯»</div>
                <div id="ind-2" class="step-ind">2. åˆ†</div>
                <div id="ind-3" class="step-ind">3. å†™</div>
            </div>
            <div>å‰©ä½™: <b id="remain-count">0</b></div>
        </div>
        <div class="stage" id="stage"></div>
        <div id="enter-tip" class="enter-tip">æŒ‰ Enter ä¸‹ä¸€æ­¥</div>
    </div>

    <script>
        // ================== å‘éŸ³å¼•æ“ (V25 å…¨é¢è‡ªå®šä¹‰) ==================
        const SpeechEngine = {
            voices: [],
            config: { word: 'ONLINE_US', prompt: 'ONLINE_UK' }, // é»˜è®¤é…ç½®

            init(savedCfg) {
                if(savedCfg) this.config = savedCfg;
                
                // åŠ è½½ç³»ç»Ÿè¯­éŸ³
                const load = () => {
                    this.voices = window.speechSynthesis.getVoices();
                    this.populateSelect('cfg-word-voice', this.config.word);
                    this.populateSelect('cfg-prompt-voice', this.config.prompt);
                };
                
                window.speechSynthesis.onvoiceschanged = load;
                load();
                setTimeout(load, 1000); // ç¡®ä¿åŠ è½½
            },

            populateSelect(elemId, currentVal) {
                const select = document.getElementById(elemId);
                // ä¿ç•™å‰ä¸¤ä¸ªåœ¨çº¿é€‰é¡¹
                select.length = 2; 
                
                // æ·»åŠ ç³»ç»Ÿè¯­éŸ³
                const enVoices = this.voices.filter(v => v.lang.includes('en'));
                enVoices.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v.voiceURI;
                    opt.text = `ğŸ’» ç³»ç»Ÿ: ${v.name}`;
                    select.appendChild(opt);
                });

                // æ¢å¤é€‰æ‹©
                select.value = currentVal;
            },

            // ç»Ÿä¸€å‘éŸ³æ¥å£
            speak(text, usePromptVoice = false) {
                const voiceID = usePromptVoice ? this.config.prompt : this.config.word;
                this.play(text, voiceID);
            },

            play(text, voiceID) {
                window.speechSynthesis.cancel(); // æŠ¢å 

                if (voiceID === 'ONLINE_US') {
                    this.playAudio(`https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(text)}&type=2`);
                } else if (voiceID === 'ONLINE_UK') {
                    this.playAudio(`https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(text)}&type=1`);
                } else {
                    // ç³»ç»Ÿè¯­éŸ³ TTS
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = 'en-US';
                    const v = this.voices.find(v => v.voiceURI === voiceID);
                    if(v) u.voice = v;
                    window.speechSynthesis.speak(u);
                }
            },

            playAudio(url) {
                const a = new Audio(url);
                a.play().catch(e => console.log("Audio play failed", e));
            },

            // æç¤ºéŸ³å†…å®¹è½¬æ¢
            playPromptSignal(type) {
                let text = "Excellent";
                if (type === 'good') text = "Good";
                if (type === 'wrong') text = "Try again";
                this.speak(text, true); // ä½¿ç”¨ prompt é…ç½®çš„å£°éŸ³
            }
        };

        // ================== æ•°æ®åº“ ==================
        const DB = {
            key: 'phonics_pro_v25_fix',
            data: { lib: [], config: { planDays: 21, voiceCfg: null } },
            load() { 
                const r = localStorage.getItem(this.key); 
                if(r) {
                    this.data = JSON.parse(r);
                    // å…¼å®¹æ—§æ•°æ®
                    if(!this.data.config.voiceCfg) {
                        this.data.config.voiceCfg = { word: 'ONLINE_US', prompt: 'ONLINE_UK' };
                    }
                }
            },
            save() { localStorage.setItem(this.key, JSON.stringify(this.data)); App.updateUI(); },
            add(list) {
                let c = 0;
                list.forEach(i => {
                    if(!this.data.lib.find(w=>w.word===i.word)) {
                        let trans = i.trans || "æš‚æ— é‡Šä¹‰";
                        const finalChunks = i.chunks || this.split(i.word);
                        this.data.lib.push({ word: i.word, trans: trans, chunks: finalChunks, status: 0, err: 0, allTimeErr: 0 });
                        c++;
                    }
                });
                alert(`å¯¼å…¥ ${c} è¯`); this.save();
            },
            split(w) { return w.length<=4 ? [w] : (w.toLowerCase().match(/[^aeiouy]*[aeiouy]+(?:[^aeiouy]*$|[^aeiouy](?=[^aeiouy]))?/gi) || [w]); }
        };

        // ================== ä¿®å¤åçš„å¯¼å…¥é€»è¾‘ (è¶…çº§ç¨³å¥) ==================
        const Importer = {
            handleFile(f) {
                if(!f) return; document.getElementById('file-name').innerText = f.name;
                const r = new FileReader();
                if(f.name.endsWith('.docx')) r.onload = e => mammoth.extractRawText({arrayBuffer:e.target.result}).then(x=>this.parse(x.value));
                else r.onload = e => this.parse(e.target.result);
                f.name.endsWith('.docx') ? r.readAsArrayBuffer(f) : r.readAsText(f);
            },
            parseManual() { this.parse(document.getElementById('manual-text').value); },
            
            // ä¿®å¤ç‰ˆè§£æå™¨ï¼šæ”¯æŒ / å’Œ ç©ºæ ¼åˆ†å‰²
            parse(txt) {
                const list = [];
                const lines = txt.split(/[\r\n]+/);
                
                lines.forEach(line => {
                    line = line.trim();
                    if(!line) return;

                    // ç­–ç•¥ï¼šæŒ‰ç©ºæ ¼åˆ†å‰²ï¼Œç¬¬ä¸€éƒ¨åˆ†ä½œä¸ºå•è¯/æ‹¼å†™ï¼Œå‰©ä½™éƒ¨åˆ†ä½œä¸ºç¿»è¯‘
                    const parts = line.split(/\s+/);
                    const rawWord = parts[0].toLowerCase();
                    const trans = parts.slice(1).join(' ');

                    let word = "";
                    let chunks = null;

                    if (rawWord.includes('/')) {
                        // å‘ç°æ‰‹åŠ¨æ‹†åˆ†ç¬¦å·
                        chunks = rawWord.split('/');
                        word = chunks.join('');
                    } else {
                        // æ™®é€šå•è¯
                        word = rawWord;
                    }

                    // ç®€å•æ ¡éªŒï¼šå¿…é¡»åŒ…å«å­—æ¯
                    if (/[a-z]/.test(word)) {
                        list.push({ word, chunks, trans });
                    }
                });

                if(list.length > 0) { 
                    DB.add(list); 
                    App.switchView('dashboard'); 
                } else { 
                    alert("æœªè¯†åˆ«åˆ°å•è¯ã€‚è¯·ç¡®ä¿æ ¼å¼æ­£ç¡®ï¼Œä¾‹å¦‚ï¼š\napple è‹¹æœ\nhand/some è‹±ä¿Šçš„"); 
                }
            }
        };

        // ================== ç»ƒä¹ é€»è¾‘ ==================
        const Practice = {
            queue: [], idx: 0, step: 1, canNext: false, mode: 'learning', currentWordHasError: false,
            start(list, mode) {
                this.queue = list; this.idx = 0; this.mode = mode;
                this.loadWord(0); document.addEventListener('keydown', this.handleKey);
            },
            stop() { document.removeEventListener('keydown', this.handleKey); App.switchView('dashboard'); },
            handleKey(e) {
                if(e.key === 'Escape') { App.endSession(); return; }
                if(Practice.mode === 'summary' && e.key === 'Enter') { Practice.stop(); return; }
                if(Practice.mode !== 'summary' && e.key === 'Enter') { 
                    e.stopPropagation(); 
                    if(Practice.canNext) Practice.next(); 
                }
            },
            loadWord(i) {
                this.idx = i; this.step = 1; this.canNext = false; this.currentWordHasError = false;
                document.getElementById('remain-count').innerText = this.queue.length - i;
                this.render();
            },
            setCanNext(b) { this.canNext = b; document.getElementById('enter-tip').classList.toggle('show', b); },

            render() {
                const data = this.queue[this.idx];
                const stage = document.getElementById('stage');
                stage.innerHTML = '';
                [1,2,3].forEach(n => document.getElementById(`ind-${n}`).className = `step-ind ${n===this.step?'active':''}`);

                // Step 1: è¯»
                if(this.step === 1) {
                    this.setCanNext(true);
                    const wordBox = document.createElement('div');
                    wordBox.style.display = 'flex'; wordBox.style.gap = '15px';
                    wordBox.innerHTML = data.chunks.map(c=>
                        `<div class="rich-input-wrapper" style="width:${Math.max(120, c.length*70)}px; height:160px; border-color:var(--primary);">
                            <div class="visual-layer" style="line-height:160px;">${this.color(c)}</div>
                         </div>`
                    ).join('');
                    stage.appendChild(wordBox);
                    const transBox = document.createElement('div');
                    transBox.className = 'instruction'; transBox.innerText = data.trans;
                    stage.appendChild(transBox);
                    setTimeout(() => SpeechEngine.speak(data.word), 100);
                }
                
                // Step 2: åˆ†æ®µæ‹¼ (åªè¯»å®Œæ•´å•è¯ï¼Œä¸è¯»åˆ‡ç‰‡)
                else if(this.step === 2) {
                    this.setCanNext(false);
                    const container = document.createElement('div');
                    container.style.display='flex'; container.style.alignItems='center';
                    data.chunks.forEach((chunk, k) => {
                        if(k>0) {
                            const sep = document.createElement('div'); sep.innerHTML = '-'; 
                            sep.style.fontSize='40px'; sep.style.color='#ccc'; sep.style.margin='0 10px';
                            container.appendChild(sep);
                        }
                        const {wrapper, input} = this.createGhostInput(chunk.length, `seg-${k}`);
                        input.disabled = (k!==0);
                        
                        // èšç„¦/è¾“å…¥æ—¶è¯»å®Œæ•´å•è¯
                        const playWord = () => SpeechEngine.speak(data.word);
                        input.addEventListener('focus', () => { if(!input.disabled) playWord(); });

                        input.addEventListener('input', () => {
                            if(input.value.toLowerCase() === chunk) {
                                wrapper.classList.add('correct'); input.disabled=true;
                                const next = document.getElementById(`seg-${k+1}`);
                                if(next) { 
                                    next.disabled=false; next.focus(); 
                                    // è‡ªåŠ¨è¯»å•è¯ï¼Œç”±ä¸Šé¢çš„ focus äº‹ä»¶å¤„ç†
                                } else { 
                                    this.setCanNext(true); 
                                    SpeechEngine.playPromptSignal('good'); 
                                }
                            } else if(input.value.length >= chunk.length) { this.triggerError(wrapper); }
                        });
                        input.addEventListener('keydown', e => { if(e.key==='Enter') e.preventDefault(); });
                        container.appendChild(wrapper);
                    });
                    stage.appendChild(container);
                    const label = document.createElement('div'); label.className = 'instruction'; label.innerText = "åˆ†æ®µæ‹¼å†™"; stage.appendChild(label);
                    setTimeout(() => { const f = document.getElementById('seg-0'); if(f) f.focus(); }, 100);
                }

                // Step 3: å®Œæ•´å†™
                else if(this.step === 3) {
                    this.setCanNext(false);
                    const {wrapper, input} = this.createGhostInput(data.word.length, 'full');
                    wrapper.style.width = '700px'; 
                    input.addEventListener('keydown', e => {
                        if(e.key === 'Enter') {
                            e.stopPropagation();
                            if(this.canNext) { Practice.next(); return; }
                            if(input.value.toLowerCase() === data.word) {
                                wrapper.classList.add('correct'); input.disabled=true;
                                this.saveResult(data); 
                                SpeechEngine.playPromptSignal('correct'); 
                                this.setCanNext(true);
                            } else { this.triggerError(wrapper); }
                        }
                    });
                    stage.appendChild(wrapper);
                    const label = document.createElement('div'); label.className = 'instruction'; label.innerText = "å¬éŸ³é»˜å†™"; stage.appendChild(label);
                    setTimeout(() => { input.focus(); SpeechEngine.speak(data.word); }, 100);
                }
            },

            createGhostInput(len, id) {
                const w = document.createElement('div'); w.className = 'rich-input-wrapper';
                w.style.width = Math.max(140, len * 70) + 'px'; w.style.height = '160px';
                const inp = document.createElement('input'); inp.className = 'ghost-input';
                inp.maxLength = len; inp.id = id; inp.autocomplete = "off";
                const vis = document.createElement('div'); vis.className = 'visual-layer';
                vis.innerHTML = `<span class="cursor"></span>`;
                inp.addEventListener('input', () => {
                    let html = this.color(inp.value);
                    if (inp.value.length < len) html += `<span class="cursor"></span>`;
                    vis.innerHTML = html;
                });
                w.append(inp, vis);
                return {wrapper:w, input:inp};
            },

            triggerError(wrapper) {
                wrapper.classList.add('error'); 
                SpeechEngine.playPromptSignal('wrong');
                this.currentWordHasError = true; 
                const dbItem = DB.data.lib.find(w => w.word === this.queue[this.idx].word);
                if(dbItem) { dbItem.err++; dbItem.allTimeErr++; }
                DB.save();
                setTimeout(() => { this.step = 1; this.render(); }, 1500);
            },

            saveResult(data) {
                const dbItem = DB.data.lib.find(w => w.word === data.word);
                if(!dbItem) return;
                if (this.mode === 'review' && !this.currentWordHasError) {
                    if(dbItem.err > 0) dbItem.err--;
                }
                dbItem.status = 1; 
                DB.save();
            },

            next() {
                if(this.step < 3) { this.step++; this.render(); }
                else { if(this.idx < this.queue.length-1) this.loadWord(this.idx+1); else this.showSummary(); }
            },
            showSummary() {
                this.mode = 'summary';
                document.getElementById('stage').innerHTML = `<div class="summary-card"><h1>ğŸ‰ å®Œæˆ</h1><p style="color:#999">æŒ‰ Enter è¿”å›</p></div>`;
                this.setCanNext(false);
            },
            color(t) { return t ? t.split('').map(c=>`<span class="${/[aeiouy]/i.test(c)?'v':'c'}">${c}</span>`).join('') : ''; }
        };

        const DataManager = {
            exportData() {
                const blob = new Blob([JSON.stringify(DB.data)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `phonics_backup.json`; a.click();
            },
            exportMistakesTxt() {
                const mistakes = DB.data.lib.filter(w => (w.allTimeErr || 0) > 0);
                if(mistakes.length === 0) return alert("ğŸ‘ æ²¡æœ‰å†å²é”™é¢˜");
                const txtContent = mistakes.map(item => `${item.word} ${item.chunks.join('/')} ${item.trans}`).join('\n');
                const blob = new Blob([txtContent], {type: "text/plain"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `mistakes.txt`; a.click();
            },
            importData(file) {
                if(!file) return;
                const r = new FileReader();
                r.onload = (e) => {
                    try {
                        const d = JSON.parse(e.target.result);
                        if(d.lib) { DB.data = d; DB.save(); alert("âœ… æ¢å¤æˆåŠŸ"); location.reload(); }
                    } catch(e) { alert("âŒ æ–‡ä»¶é”™è¯¯"); }
                };
                r.readAsText(file);
            },
            resetData() { if(confirm("âš ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ")) { localStorage.removeItem(DB.key); location.reload(); } }
        };

        const App = {
            init() { 
                DB.load(); this.updateUI(); 
                SpeechEngine.init(DB.data.config.voiceCfg);
                document.addEventListener('keydown', (e) => {
                    if(document.getElementById('view-dashboard').classList.contains('active') && e.key === 'Enter') { App.start('daily'); }
                });
            },
            switchView(id) { document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+id).classList.add('active'); this.updateUI(); },
            updateUI() {
                const l = DB.data.lib;
                document.getElementById('stat-total').innerText = l.length;
                document.getElementById('stat-learned').innerText = l.filter(w=>w.status==1).length;
                document.getElementById('stat-remain').innerText = l.filter(w=>w.status==0).length;
                document.getElementById('stat-mistakes').innerText = l.filter(w=>w.err>0).length;
                document.getElementById('daily-target').innerText = Math.ceil(l.filter(w=>w.status==0).length / DB.data.config.planDays) || 0;
            },
            saveConfig() { DB.data.config.planDays = document.getElementById('plan-days').value; DB.save(); },
            saveVoiceConfig() {
                const cfg = {
                    word: document.getElementById('cfg-word-voice').value,
                    prompt: document.getElementById('cfg-prompt-voice').value
                };
                DB.data.config.voiceCfg = cfg;
                SpeechEngine.config = cfg;
                DB.save();
            },
            start(mode) {
                const l = DB.data.lib;
                let list = [];
                if(mode==='daily') {
                    let pool = l.filter(w=>w.status==0);
                    if(!pool.length) pool = l.filter(w=>w.status==1);
                    if(!pool.length) return alert("æ²¡æœ‰è¯æ±‡");
                    const c = parseInt(document.getElementById('daily-target').innerText) || 10;
                    const rnd = document.getElementById('learn-order').value==='random';
                    list = rnd ? pool.sort(()=>0.5-Math.random()).slice(0,c) : pool.slice(0,c);
                } else {
                    list = l.filter(w=>w.err>0);
                    if(!list.length) return alert("æ²¡æœ‰é”™é¢˜");
                }
                App.switchView('practice'); Practice.start(list, mode);
            },
            endSession() { if(confirm("é€€å‡º?")) { Practice.stop(); App.switchView('dashboard'); } }
        };
        App.init();
    </script>
</body>
</html>
